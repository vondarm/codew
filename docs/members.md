# Управление участниками рабочей области

Функциональность участников позволяет администраторам рабочих областей CodeW управлять членами команды и их ролями. Система основана на новой модели `Member`, которая связывает пользователей (`User`) и рабочие области (`Workspace`).

## Модель данных

```prisma
enum MemberRole {
  ADMIN
  EDITOR
  VIEWER
}

model Member {
  id           String     @id @default(cuid())
  workspaceId  String
  userId       String
  invitedById  String?
  role         MemberRole @default(VIEWER)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitedBy User?     @relation("MemberInvitedBy", fields: [invitedById], references: [id], onDelete: SetNull)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}
```

- Владелец рабочей области автоматически становится участником с ролью `ADMIN`. Backfill-миграция создаёт такие записи для существующих пространств.
- Обеспечивается уникальность пары `workspaceId` + `userId`, что исключает дублирование членства.
- Таблица хранит метаданные о пригласившем (`invitedById`) и автоматически обновляет поле `updatedAt`.

## Роли и права доступа

| Роль   | Права                                                                         |
| ------ | ----------------------------------------------------------------------------- |
| ADMIN  | Управление участниками, настройками рабочей области, доступ ко всем комнатам. |
| EDITOR | Работа в комнатах (создание, редактирование), без управления участниками.     |
| VIEWER | Просмотр комнат и материалов без возможности редактирования.                  |

Минимум один администратор должен оставаться в каждой рабочей области. Попытка удалить или понизить последнего администратора блокируется на уровне сервиса.

## Серверный слой

### Prisma-репозиторий

`src/lib/prisma/member.ts` содержит функции для работы с моделью: получение списка участников, поиск по workspace/user, создание и удаление записей, подсчёт администраторов и поиск пользователя по email.

### MemberService

`src/lib/services/member.ts` инкапсулирует бизнес-логику:

- `inviteMember({ workspaceId, inviterId, email, role })` — приглашение существующего пользователя по email. Проверяются формат и наличие пользователя, отсутствие членства, права администратора у инициатора.
- `changeRole({ workspaceId, actorId, memberId, role })` — смена роли участника. Нельзя понизить последнего администратора. При понижении/удалении владельца выбирается новый владелец (активный администратор или первый доступный админ).
- `removeMember({ workspaceId, actorId, memberId })` — удаление участника с аналогичными проверками.
- `listMembers(workspaceId)` — выборка участников с информацией о пользователях.

Ошибки сервиса представлены классом `MemberServiceError` с кодами (`VALIDATION_ERROR`, `USER_NOT_FOUND`, `ALREADY_MEMBER`, `LAST_ADMIN` и др.), что позволяет корректно отображать сообщения в UI и Server Actions.

## Server Actions

`src/app/workspaces/[workspaceId]/members-actions.ts` содержит server actions для UI:

- `inviteMemberAction` — обрабатывает форму приглашения, вызывает `MemberService.inviteMember` и выполняет `revalidatePath`.
- `changeMemberRoleAction` — меняет роль выбранного участника.
- `removeMemberAction` — удаляет участника.

Каждое действие возвращает состояние (`MemberActionState`) с информацией об успехе, ошибке и полях с валидацией.

## Пользовательский интерфейс

Страница `/workspaces/[workspaceId]` доступна только администраторам и включает:

- Карточку с информацией о рабочей области и количестве администраторов.
- Форму приглашения существующего пользователя по email с выбором роли.
- Таблицу участников с аватаром, email, ролью и датой добавления.
- Кнопки «Изменить роль» и «Удалить» для каждого участника. Последнего администратора удалить нельзя.

После успешных операций отображаются уведомления и страница автоматически обновляется за счёт `revalidatePath`.

## Тестирование и миграции

- Добавлена миграция `20250921000000_add_members`, создающая таблицу `Member` и backfill для владельцев существующих рабочих областей.
- Для корректной работы необходимо выполнить `yarn prisma:generate` и применить миграцию через `prisma migrate` или `prisma db push` в соответствующем окружении.
- Для проверки бизнес-логики используется тесты Vitest (`yarn test`). Они покрывают основные сценарии: успешное приглашение, обработку отсутствующего пользователя, защиту от удаления последнего администратора.
