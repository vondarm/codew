# Комнаты интервью

Комнаты позволяют подготовить среду для технического интервью: задать название, поделиться ссылкой для кандидата и
управлять анонимным доступом. В рамках рабочей области комнаты создаются и управляются редакторами и администраторами.

## Модель Prisma

Модель `Room` добавлена в `schema.prisma` и включает:

- `id` — идентификатор (cuid).
- `workspaceId` — связь с рабочей областью.
- `createdById` — пользователь, создавший комнату.
- `name` — название комнаты (уникально в рамках рабочей области).
- `slug` — публичная ссылка, уникальна глобально.
- `status` — перечисление `RoomStatus` (`ACTIVE`, `CLOSED`, `ARCHIVED`).
- `allowAnonymousView`, `allowAnonymousEdit`, `allowAnonymousJoin` — флаги анонимного доступа.
- `code` — текстовый блок с инструкциями или стартовым кодом (по умолчанию пустой).
- `archivedAt`/`closedAt` — временные метки для истории.
- `createdAt`, `updatedAt` — стандартные временные поля.

Модель связана с `Workspace` и `User`, уникальные индексы гарантируют уникальность `slug` и `(workspaceId, name)`.

## RoomService

Сервис предоставляет операции:

- `createRoom` — валидация названия, генерация случайного slug (с защитой от коллизий), сохранение флагов доступа и кода.
- `listRoomsForWorkspace` — выдаёт комнаты рабочего пространства для участника.
- `getRoom` — загружает комнату по slug, проверяя права участника или анонимный доступ.
- `updateRoom` — изменяет настройки (название, флаги, код).
- `closeRoom` — переводит комнату в статус `CLOSED`, отключая анонимное редактирование/подключение.
- `regenerateRoomSlug` — выпускает новую ссылку, инвалидируя предыдущую.

Ошибки маппятся на `RoomError` с кодами `NOT_FOUND`, `FORBIDDEN`, `VALIDATION_ERROR`, `UNKNOWN`.

## UI и серверные действия

- Страница рабочей области `/workspaces/[workspaceId]/rooms` отображает список комнат, позволяет создавать, редактировать,
  закрывать и генерировать новые ссылки. Для действий используются серверные функции в `app/workspaces/[workspaceId]/rooms/actions.ts`.
- Страница комнаты `/rooms/[roomSlug]` загружает данные через `RoomService`. Участники с правами редактора видят кнопку
  редактирования, обновления ссылки и закрытия комнаты. Анонимный доступ показывает экран ожидания без возможности
  управления.
- Компоненты используют `useActionState`, чтобы отображать ошибки валидации и сообщения об успехе.

## Анонимный доступ

- `allowAnonymousView` — позволяет открыть страницу комнаты по slug без авторизации.
- `allowAnonymousEdit` — включает совместное редактирование для анонимов (при закрытии комнаты автоматически выключается).
- `allowAnonymousJoin` — разрешает подключение к сессии без учётной записи.

Для кандидатов отображается страница ожидания до подключения интервьюера.

## Статусы комнат

- `ACTIVE` — комната открыта и доступна по ссылке.
- `CLOSED` — редактирование отключено, анонимные права сброшены.
- `ARCHIVED` — зарезервировано для будущего архивирования (не используется в текущем UI).

## Тестирование

- Юнит-тесты `RoomService` находятся в `src/lib/services/__tests__/room.test.ts`.
- Для ручной проверки: создайте комнату, скопируйте ссылку, обновите флаги доступа, затем закройте комнату и убедитесь, что
  статус изменился как в списке комнат, так и на странице самой комнаты.
